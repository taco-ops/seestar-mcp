name: Create Release

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Type of version increment'
        required: true
        default: 'patch'
        type: choice
        options:
        - patch
        - minor
        - major
        - prerelease
      prerelease_type:
        description: 'Prerelease type (only if prerelease selected)'
        required: false
        default: 'beta'
        type: choice
        options:
        - alpha
        - beta
        - rc

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"

    - name: Set up Python
      run: uv python install 3.11

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: "18"

    - name: Install Python dependencies
      run: |
        uv venv --python 3.11
        uv pip install -e ".[dev]"

    - name: Install Node.js dependencies
      run: npm install

    - name: Run pre-commit hooks
      run: |
        uv run pre-commit run --all-files

    - name: Run Python tests
      run: |
        uv run pytest

    - name: Run MCP tests
      run: |
        npm test

    - name: Configure Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"

    - name: Create release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        if [ "${{ inputs.version_type }}" = "prerelease" ]; then
          npm run release -- --increment=prerelease --preRelease=${{ inputs.prerelease_type }} --ci
        else
          npm run release -- --increment=${{ inputs.version_type }} --ci
        fi
